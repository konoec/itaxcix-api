<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Gestión de Usuarios</title>
    <link rel="icon" type="image/png" href="../../assets/Recourse/Logo/1.png">
    <link rel="shortcut icon" href="../../assets/Recourse/Logo/1.png">
    
    <!-- Tabler CSS Framework -->
    <link rel="stylesheet" href="../../assets/tabler/css/tabler.min.css">
    <link rel="stylesheet" href="../../assets/tabler/css/tabler-vendors.min.css">
    <link rel="stylesheet" href="../../assets/css/global-toast.css">
    <link rel="stylesheet" href="../../assets/css/sidebar.css">
    <link rel="stylesheet" href="../../assets/css/topbar.css">
    <link rel="stylesheet" href="../../assets/css/profile.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Configuración de la página -->
    <script>
        window.pageConfig = {
            activeSection: 'configuracion',
            pageTitle: {
                icon: 'fas fa-users',
                text: 'Gestión de Usuarios'
            }
        };
    </script>
    
</head>
<body>
    <!-- Contenedor principal del layout usando estructura Tabler -->
    <div class="page">
        <!-- Contenedor del sidebar - se carga dinámicamente -->
        <div id="sidebar-container"></div>

        <!-- Contenido principal usando estructura Tabler -->
        <div class="page-wrapper">
            <!-- Contenedor del topbar - se carga dinámicamente -->
            <div id="topbar-container"></div>
            
            <!-- Contenido principal de la página -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Header del módulo -->
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col">
                    </div>

                    <!-- Filtros y controles -->
                    <div class="row g-2 mb-3">
                        <div class="col-12 col-md-6 col-lg-3">
                            <div class="input-group">
                                <input type="text" id="search-users" class="form-control" placeholder="Buscar por nombre, apellido o documento...">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>

                        <div class="col-12 col-md-6 col-lg-2">
                            <select class="form-select" id="filter-user-type">
                                <option value="">Todos los tipos</option>
                                <option value="admin">Administrador</option>
                                <option value="citizen">Ciudadano</option>
                                <option value="driver">Conductor</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-2">
                            <select class="form-select" id="filter-driver-status">
                                <option value="">Estado conductor</option>
                                <option value="PENDIENTE">Pendiente</option>
                                <option value="APROBADO">Aprobado</option>
                                <option value="RECHAZADO">Rechazado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6 col-lg-1">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-filter me-1"></i>
                                    <span class="d-none d-lg-inline">Más</span>
                                </button>
                                <div class="dropdown-menu" style="min-width: 200px;">
                                    <h6 class="dropdown-header">Filtros adicionales</h6>
                                    <div class="dropdown-item">
                                        <label class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filter-has-vehicle">
                                            <span class="form-check-label">Con vehículo</span>
                                        </label>
                                    </div>
                                    <div class="dropdown-item">
                                        <label class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filter-contact-verified">
                                            <span class="form-check-label">Contactos verificados</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 col-lg-1">
                            <button class="btn btn-outline-secondary w-100" id="clear-filters">
                                <i class="fas fa-times me-2"></i>
                                <span class="d-none d-sm-inline">Limpiar</span>
                            </button>
                        </div>
                        <div class="col-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-outline-secondary" id="refresh-users-btn" title="Refrescar usuarios">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-primary" id="create-user-btn" title="Crear Usuario">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de usuarios -->
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-vcenter card-table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th class="d-none d-md-table-cell">Documento</th>
                                            <th class="d-none d-lg-table-cell">Email</th>
                                            <th class="d-none d-lg-table-cell">Teléfono</th>
                                            <th>Estado</th>
                                            <th class="w-1">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-list">
                                        <!-- Loading indicator -->
                                        <tr id="loading-row">
                                            <td colspan="6" class="text-center py-5">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <div class="mt-2 text-muted">Cargando usuarios...</div>
                                            </td>
                                        </tr>
                                        <!-- El contenido se carga dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Paginación -->
                        <div class="card-footer d-flex align-items-center">
                            <div class="d-flex align-items-center">
                                <p class="m-0 text-muted me-3">
                                    Mostrando <span id="showing-start">0</span> a <span id="showing-end">0</span> de <span id="total-users">0</span> usuarios
                                </p>
                                <div class="d-flex align-items-center">
                                    <label class="form-label mb-0 me-2 text-muted">Mostrar:</label>
                                    <select class="form-select form-select-sm" id="items-per-page" style="width: auto;">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="15">15</option>
                                        <option value="20">20</option>
                                    </select>
                                    <span class="ms-2 text-muted">por página</span>
                                </div>
                            </div>
                            <ul class="pagination m-0 ms-auto" id="pagination-container">
                                <!-- La paginación se genera dinámicamente -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor para modales dinámicos -->
    <div id="modal-container"></div>

    <!-- Toast notification -->
    <div id="recovery-toast" class="recovery-toast">
        <div class="recovery-toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="recovery-toast-message">Operación completada exitosamente</span>
        </div>
    </div>

    <!-- Modal de detalles de usuario -->
    <div class="modal modal-blur fade" id="user-details-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="max-width: 800px;">
            <div class="modal-content" style="max-height: 85vh;">
                <div class="modal-header border-0">
                    <h5 class="modal-title">
                        <i class="fas fa-user me-2"></i>
                        Detalles del Usuario
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0" style="max-height: calc(85vh - 80px); overflow-y: auto; overflow-x: hidden;" id="user-details-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de creación de usuario administrador -->
    <div class="modal modal-blur fade" id="user-create-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 600px;">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h5 class="modal-title d-flex align-items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                            <path d="M16 19h6"></path>
                            <path d="M19 16v6"></path>
                            <path d="M6 21v-2a4 4 0 0 1 4 -4h4"></path>
                        </svg>
                        Crear Usuario Administrador
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="user-create-form" novalidate>
                    <div class="modal-body py-3">
                        <div class="row g-2">
                            <!-- Documento y Email -->
                            <div class="col-12 col-sm-6">
                                <div class="mb-2">
                                    <label class="form-label required text-muted small">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M3 4m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z"></path>
                                            <path d="M9 10m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                            <path d="M15 8l2 0"></path>
                                            <path d="M15 12l2 0"></path>
                                            <path d="M7 16l10 0"></path>
                                        </svg>
                                        DNI
                                    </label>
                                    <input type="text" class="form-control form-control-sm" id="user-document" name="document" 
                                           required maxlength="8" pattern="[0-9]{8}" placeholder="12345678"
                                           autocomplete="off">
                                    <div class="invalid-feedback">
                                        8 dígitos requeridos
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-6">
                                <div class="mb-2">
                                    <label class="form-label required text-muted small">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"></path>
                                            <path d="M3 7l9 6l9 -6"></path>
                                        </svg>
                                        Email
                                    </label>
                                    <input type="email" class="form-control form-control-sm" id="user-email" name="email" 
                                           required placeholder="admin@itaxcix.com"
                                           autocomplete="email">
                                    <div class="invalid-feedback">
                                        Email válido requerido
                                    </div>
                                </div>
                            </div>

                            <!-- Contraseña -->
                            <div class="col-12">
                                <div class="mb-2">
                                    <label class="form-label required text-muted small">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z"></path>
                                            <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0"></path>
                                            <path d="M8 11v-4a4 4 0 1 1 8 0v4"></path>
                                        </svg>
                                        Contraseña
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <input type="password" class="form-control" id="user-password" name="password" 
                                               required minlength="6" placeholder="Incluya mayúscula, número y símbolo"
                                               autocomplete="new-password">
                                        <button class="btn btn-outline-secondary" type="button" id="toggle-password" 
                                                title="Mostrar/Ocultar">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                <path d="M10 12a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                                <path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">
                                        La contraseña debe tener mínimo 6 caracteres, incluyendo: mayúscula, número y carácter especial (@$!%*?&)
                                    </div>
                                    <small class="form-hint">Debe incluir: mayúscula, número y carácter especial (@$!%*?&)</small>
                                </div>
                            </div>
                            
                            <!-- Área y Posición -->
                            <div class="col-12 col-sm-6">
                                <div class="mb-2">
                                    <label class="form-label required text-muted small">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M3 21l18 0"></path>
                                            <path d="M5 21v-14l8 -4v18"></path>
                                            <path d="M19 21v-10l-6 -4"></path>
                                            <path d="M9 9l0 .01"></path>
                                            <path d="M9 12l0 .01"></path>
                                            <path d="M9 15l0 .01"></path>
                                            <path d="M9 18l0 .01"></path>
                                        </svg>
                                        Área
                                    </label>
                                    <input type="text" class="form-control form-control-sm" id="user-area" name="area" 
                                           required placeholder="Sistemas"
                                           autocomplete="organization">
                                    <div class="invalid-feedback">
                                        Área requerida
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12 col-sm-6">
                                <div class="mb-2">
                                    <label class="form-label required text-muted small">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                                            <path d="M6 21v-2a4 4 0 0 1 4 -4h.5"></path>
                                            <path d="M17.8 20.817l-2.172 1.138a.392 .392 0 0 1 -.568 -.41l.415 -2.411l-1.757 -1.707a.389 .389 0 0 1 .217 -.665l2.428 -.352l1.086 -2.193a.392 .392 0 0 1 .702 0l1.086 2.193l2.428 .352a.39 .39 0 0 1 .217 .665l-1.757 1.707l.414 2.41a.39 .39 0 0 1 -.567 .411l-2.172 -1.138z"></path>
                                        </svg>
                                        Posición
                                    </label>
                                    <input type="text" class="form-control form-control-sm" id="user-position" name="position" 
                                           required placeholder="Administrador General"
                                           autocomplete="organization-title">
                                    <div class="invalid-feedback">
                                        Posición requerida
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M18 6l-12 12"></path>
                                <path d="M6 6l12 12"></path>
                            </svg>
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary btn-sm" id="save-user-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M6 4h10l4 4v10a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-16a2 2 0 0 1 2 -2"></path>
                                <path d="M12 14m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M14 4l0 4l-6 0l0 -4"></path>
                            </svg>
                            <span class="btn-text">Crear Usuario</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal modal-blur fade" id="confirm-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                    <h3 id="confirm-title">¿Confirmar acción?</h3>
                    <p class="text-muted" id="confirm-message">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de asignación de roles -->
    <div class="modal modal-blur fade" id="assign-roles-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-tag me-2"></i>
                        Asignar Roles
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Información del usuario -->
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="d-flex align-items-center">
                                    <span class="avatar avatar-sm me-2">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <div>
                                        <h4 class="mb-0" id="assign-roles-user-name">Usuario</h4>
                                        <small class="text-muted" id="assign-roles-user-info">Información del usuario</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contenido principal en dos columnas -->
                    <div class="row g-3">
                        <!-- Columna izquierda: Roles -->
                        <div class="col-md-8">
                            <!-- Buscador de roles -->
                            <div class="mb-3">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="search-roles-modal" placeholder="Buscar roles...">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                            </div>

                            <!-- Lista de roles -->
                            <div class="card">
                                <div class="card-header py-2">
                                    <h3 class="card-title">Roles disponibles</h3>
                                    <div class="card-actions">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="filter-assigned-roles">
                                            <label class="form-check-label" for="filter-assigned-roles">
                                                Solo asignados
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <!-- Loading state -->
                                    <div id="roles-loading" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando roles...</span>
                                        </div>
                                        <div class="mt-2 text-muted">Cargando roles disponibles...</div>
                                    </div>
                                    
                                    <!-- Roles list -->
                                    <div class="table-responsive" id="roles-table-container" style="display: none; max-height: 300px; overflow-y: auto;">
                                        <table class="table table-vcenter card-table table-sm">
                                            <thead>
                                                <tr>
                                                    <th class="w-1">
                                                        <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                                                    </th>
                                                    <th>Rol</th>
                                                    <th>Tipo</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="roles-list">
                                                <!-- Roles se cargan dinámicamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Empty state -->
                                    <div id="roles-empty" class="text-center py-3" style="display: none;">
                                        <i class="fas fa-search text-muted fa-2x mb-2"></i>
                                        <h4 class="text-muted">No se encontraron roles</h4>
                                        <p class="text-muted mb-0">No hay roles que coincidan con la búsqueda</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna derecha: Acciones administrativas -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header py-2">
                                    <h3 class="card-title">
                                        <i class="fas fa-cog me-2"></i>
                                        Acciones
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <!-- Correo Electrónico -->
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Correo Electrónico</label>
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="text" class="form-control" id="user-email-display" 
                                                   placeholder="Cargando..." readonly style="background-color: #f8f9fa;">
                                        </div>
                                        <button type="button" class="btn btn-success btn-sm w-100" id="verify-email-btn">
                                            <i class="fas fa-check me-1"></i>
                                            Verificar Email
                                        </button>
                                    </div>

                                    <!-- Teléfono -->
                                    <div class="mb-3">
                                        <label class="form-label text-muted small mb-1">Teléfono</label>
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="text" class="form-control" id="user-phone-display" 
                                                   placeholder="Cargando..." readonly style="background-color: #f8f9fa;">
                                        </div>
                                        <button type="button" class="btn btn-success btn-sm w-100" id="verify-phone-btn">
                                            <i class="fas fa-check me-1"></i>
                                            Verificar Teléfono
                                        </button>
                                    </div>

                                    <!-- Actualizar contraseña -->
                                    <div>
                                        <label class="form-label text-muted small mb-1">Actualizar Contraseña</label>
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="password" class="form-control" id="new-password-input" 
                                                   placeholder="Nueva contraseña">
                                            <button class="btn btn-outline-secondary" type="button" id="toggle-new-password" 
                                                    title="Mostrar/Ocultar contraseña">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <button type="button" class="btn btn-warning btn-sm w-100" id="reset-password-btn">
                                            <i class="fas fa-key me-1"></i>
                                            Actualizar Contraseña
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" id="save-roles-btn">
                        <i class="fas fa-save me-1"></i>
                        Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de carga de permisos -->
    <div id="permissions-loading" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(255, 255, 255, 0.9); z-index: 9999; display: none !important;">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h3 class="h4 mb-1">Configurando Usuarios</h3>
            <p class="text-muted mb-1">Estamos configurando tu sesión y verificando la gestión de usuarios...</p>
            <p class="text-muted small" id="loading-step">Validando credenciales...</p>
        </div>
    </div>

    <!-- Scripts de Tabler -->
    <script src="../../assets/tabler/js/tabler.min.js"></script>
    
    <!-- Scripts de autenticación y permisos -->
    <script src="../../assets/js/auth/auth-checker.js"></script>
    <script src="../../assets/js/auth/permissions.js"></script>
    <script src="../../assets/js/auth/route-guard.js"></script>
    
    <!-- Scripts de servicios -->
    <script src="../../assets/js/api/services/Configuration/user-service.js"></script>
    <script src="../../assets/js/api/services/Configuration/user-create-service.js"></script>
    <script src="../../assets/js/api/services/Configuration/role-service.js"></script>
    <script src="../../assets/js/api/services/Configuration/assign-role-service.js"></script>
    <script src="../../assets/js/api/services/Configuration/verify-contact-service.js"></script>
    <script src="../../assets/js/api/services/Configuration/reset-password-service.js"></script>
    <script src="../../assets/js/api/services/profile-service.js"></script>
    
    <!-- Scripts de UI -->
    <script src="../../assets/js/ui/component-loader.js"></script>
    <script src="../../assets/js/ui/global-toast.js"></script>
    
    <!-- Scripts de controladores base (ANTES del MainController) -->
    <script src="../../assets/js/ui/controllers/Components/sidebar-controller.js"></script>
    <script src="../../assets/js/ui/controllers/Components/topbar-controller.js"></script>
    <script src="../../assets/js/ui/controllers/Components/profile-controller.js"></script>
    
    <!-- Controlador principal (DESPUÉS de los controladores base) -->
    <script src="../../assets/js/ui/controllers/Configuration/users/main-controller.js"></script>
    <script src="../../assets/js/ui/controllers/Configuration/users/users-list-controller.js"></script>
    <script src="../../assets/js/ui/controllers/Configuration/users/user-details-controller.js"></script>
    <script src="../../assets/js/ui/controllers/Configuration/users/user-create-controller.js"></script>
    <script src="../../assets/js/ui/controllers/Configuration/users/assign-roles-controller.js"></script>
    
    <!-- Inicializadores -->
    <script src="../../assets/js/ui/initializers/Configuration/users-initializer.js"></script>
    <script src="../../assets/js/global-initializer.js"></script>

    <!-- Script para manejo del formulario de usuario -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar/ocultar campos según el tipo de usuario
            const userTypeSelect = document.getElementById('user-type');
            const driverStatusSection = document.getElementById('driver-status-section');
            
            if (userTypeSelect && driverStatusSection) {
                userTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    
                    if (selectedType === 'driver') {
                        driverStatusSection.style.display = 'block';
                        driverStatusSection.querySelector('select').required = true;
                    } else {
                        driverStatusSection.style.display = 'none';
                        driverStatusSection.querySelector('select').required = false;
                        driverStatusSection.querySelector('select').value = '';
                    }
                });
            }
        });
    </script>

</body>
</html>
